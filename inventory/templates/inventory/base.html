{% load static %}
<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>{% block title %}ì¬ê³ ê´€ë¦¬ ì‹œìŠ¤í…œ{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body>
  <!-- âœ… ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="navbar">
    <div class="nav-links">
      <a href="{% url 'kiosk_input' %}">ì†Œëª¨ ì…ë ¥</a>
      <a href="{% url 'add_stock' %}">ì…ê³  ì¶”ê°€</a>
      <a href="{% url 'inventory_status' %}">ì¬ê³  í˜„í™©</a>
      <a href="{% url 'inventory_history' %}">ì…ì¶œê³  ë‚´ì—­</a>
      <a href="{% url 'pending_stock_list' %}">ì…ê³ ëŒ€ê¸°</a>
    </div>
    <div>
      <button onclick="openModal('addItemModal')">â• ìƒˆ í’ˆëª© ì¶”ê°€</button>
    </div>
  </nav>

  <!-- âœ… í˜ì´ì§€ íƒ€ì´í‹€ -->
  <h2>{{ page_title }}</h2>

  <!-- âœ… ë©”ì‹œì§€ ì•Œë¦¼ -->
  {% if messages %}
  {% for message in messages %}
  {% if message.tags == 'error' %}
  <div id="alertBox" class="alert-box">
    <div class="alert-close"><button onclick="closeAlert()">&times;</button></div>
    {{ message }}
  </div>
  <script>
    function closeAlert() {
      const alertBox = document.getElementById("alertBox");
      if (alertBox) alertBox.remove();
    }
  </script>
  {% endif %}
  {% endfor %}
  {% endif %}

  <!-- âœ… ë³¸ë¬¸ ì½˜í…ì¸  -->
  {% block content %}{% endblock %}

  <!-- âœ… ê³µí†µ ëª¨ë‹¬ -->
  {% include 'inventory/includes/confirm_modal.html' %}

  <!-- âœ… ìƒˆ í’ˆëª© ì¶”ê°€ ëª¨ë‹¬ (ì§ì ‘ í¬í•¨) -->
  <!-- âœ… ìƒˆ í’ˆëª© ì¶”ê°€ ëª¨ë‹¬ -->
  <div id="addItemModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.4); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 24px 32px; border-radius: 8px; width: 400px; position: relative;">
      <button onclick="closeModal('addItemModal')"
        style="position: absolute; top: 10px; right: 12px; font-size: 18px;">âœ–</button>
      <h3 style="margin-top: 0;">â• ìƒˆ í’ˆëª© ì¶”ê°€</h3>

      <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 10px;">
        <label>
          ğŸ“¦ í’ˆëª©ëª…
          <input type="text" id="newItemName" placeholder="ì˜ˆ: í˜„ìˆ˜ë§‰" style="width: 100%; padding: 6px;">
        </label>

        <label>
          ğŸ“ ê·œê²© (ì‰¼í‘œë¡œ êµ¬ë¶„)
          <input type="text" id="newItemSpecs" placeholder="ì˜ˆ: 60í­, 70í­, 80í­" style="width: 100%; padding: 6px;">
        </label>

        <label>
          ğŸ“‚ ì¹´í…Œê³ ë¦¬
          <select id="newItemCategory" style="width: 100%; padding: 6px;">
            {% if categories %}
            {% for category in categories %}
            <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
            {% else %}
            <option disabled>ì‚¬ìš©ì²˜ ì—†ìŒ</option>
            {% endif %}
          </select>
        </label>

        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
          <button onclick="submitNewItem()" class="btn btn-primary">ì¶”ê°€</button>
          <button onclick="closeModal('addItemModal')" class="btn btn-outline">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  </div>


  <!-- âœ… ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    function openModal(id) {
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'flex';
    }

    function closeModal(id) {
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'none';
    }

    function openSpecModal(itemId, itemName) {
      const specList = document.getElementById("specList");
      specList.innerHTML = '';
      const variants = variantMap[String(itemId)] || [];

      const itemCard = document.querySelector(`.variant-card[data-item-id="${itemId}"]`);
      const itemDescription = itemCard?.dataset.description || "";

      variants.forEach(v => {
      const btn = document.createElement("button");
      // â˜… ì¬ê³  í‘œê¸° ì¶”ê°€!
      btn.innerHTML = `${v.spec_label} <span style="color:#666;font-size:12px;">(${v.stock ?? 0}ê°œ)</span>`;
      btn.style.padding = '6px';
      btn.onclick = () => {
        selectVariant(v.id, `${itemName} - ${v.spec_label}`);
        closeSpecModal();
    };
      specList.appendChild(btn);
    });

      document.getElementById("specModalTitle").innerText = `${itemName} - ê·œê²© ì„ íƒ`;
      document.getElementById("specDescription").innerText = itemDescription;
      document.getElementById("specModal").style.display = 'flex';
    }

    function confirmAction() {
      alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
      closeModal('exampleModal');
    }

    function submitNewItem() {
      const name = document.getElementById('newItemName').value;
      const specs = document.getElementById('newItemSpecs').value;
      const categoryId = document.getElementById('newItemCategory').value;

      fetch("{% url 'add_item_ajax' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
          name: name,
          specs: specs,
          category_id: categoryId
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert("âœ… í’ˆëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
            closeModal('addItemModal');
            location.reload();
          } else {
            alert("âŒ ì¶”ê°€ ì‹¤íŒ¨: " + (data.message || 'ì˜¤ë¥˜ ë°œìƒ'));
          }
        });
    }
    window.addEventListener('click', function (event) {
      const modal = document.getElementById('addItemModal');
      if (modal && event.target === modal) {
        modal.style.display = 'none';
      }
      const batchModal = document.getElementById('batchModal');
      if (batchModal && event.target === batchModal) {
        batchModal.style.display = 'none';
      }

      const confirmModal = document.getElementById('confirmModal');
      if (confirmModal && event.target === confirmModal) {
        confirmModal.style.display = 'none';
      }

      const specModal = document.getElementById('specModal');
      if (specModal && event.target === specModal) {
        specModal.style.display = 'none';
      }
    });

    function toggleFavorite(e, itemId) {
      e.stopPropagation(); // ëª¨ë‹¬ ì—´ê¸° ë°©ì§€
      let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");

      if (favorites.includes(itemId)) {
        favorites = favorites.filter(id => id !== itemId);
      } else {
        favorites.push(itemId);
      }

      localStorage.setItem("favorites", JSON.stringify(favorites));
      updateFavoriteIcons();  // ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì•„ì´ì½˜ê³¼ ì •ë ¬ ê°±ì‹ 
    }

    function updateFavoriteIcons() {
      const favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
      const grid = document.getElementById("item-grid");
      const cards = Array.from(grid.children);

      const favoriteCards = [];
      const otherCards = [];

      cards.forEach(card => {
        const itemId = card.getAttribute("data-item-id");
        const icon = card.querySelector(".favorite-icon");

        if (favorites.includes(itemId)) {
          icon.textContent = "â˜…";
          icon.classList.add("favorited");
          favoriteCards.push(card);
        } else {
          icon.textContent = "â˜†";
          icon.classList.remove("favorited");
          otherCards.push(card);
        }
      });

      grid.innerHTML = "";
      [...favoriteCards, ...otherCards].forEach(card => grid.appendChild(card));
    }

    document.addEventListener("DOMContentLoaded", updateFavoriteIcons);
  </script>
</body>

</html>