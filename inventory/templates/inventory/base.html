{% load static %}
<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>{% block title %}재고관리 시스템{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body>
  <!-- ✅ 네비게이션 -->
  <nav class="navbar">
    <div class="nav-links">
      <a href="{% url 'kiosk_input' %}">소모 입력</a>
      <a href="{% url 'add_stock' %}">입고 추가</a>
      <a href="{% url 'inventory_status' %}">재고 현황</a>
      <a href="{% url 'inventory_history' %}">입출고 내역</a>
      <a href="{% url 'pending_stock_list' %}">입고대기</a>
    </div>
    <div>
      <button onclick="openModal('addItemModal')">➕ 새 품목 추가</button>
    </div>
  </nav>

  <!-- ✅ 페이지 타이틀 -->
  <h2>{{ page_title }}</h2>

  <!-- ✅ 메시지 알림 -->
  {% if messages %}
  {% for message in messages %}
  {% if message.tags == 'error' %}
  <div id="alertBox" class="alert-box">
    <div class="alert-close"><button onclick="closeAlert()">&times;</button></div>
    {{ message }}
  </div>
  <script>
    function closeAlert() {
      const alertBox = document.getElementById("alertBox");
      if (alertBox) alertBox.remove();
    }
  </script>
  {% endif %}
  {% endfor %}
  {% endif %}

  <!-- ✅ 본문 콘텐츠 -->
  {% block content %}{% endblock %}

  <!-- ✅ 공통 모달 -->
  {% include 'inventory/includes/confirm_modal.html' %}

  <!-- ✅ 새 품목 추가 모달 (직접 포함) -->
  <!-- ✅ 새 품목 추가 모달 -->
  <div id="addItemModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.4); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 24px 32px; border-radius: 8px; width: 400px; position: relative;">
      <button onclick="closeModal('addItemModal')"
        style="position: absolute; top: 10px; right: 12px; font-size: 18px;">✖</button>
      <h3 style="margin-top: 0;">➕ 새 품목 추가</h3>

      <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 10px;">
        <label>
          📦 품목명
          <input type="text" id="newItemName" placeholder="예: 현수막" style="width: 100%; padding: 6px;">
        </label>

        <label>
          📏 규격 (쉼표로 구분)
          <input type="text" id="newItemSpecs" placeholder="예: 60폭, 70폭, 80폭" style="width: 100%; padding: 6px;">
        </label>

        <label>
          📂 카테고리
          <select id="newItemCategory" style="width: 100%; padding: 6px;">
            {% if categories %}
            {% for category in categories %}
            <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
            {% else %}
            <option disabled>사용처 없음</option>
            {% endif %}
          </select>
        </label>

        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
          <button onclick="submitNewItem()" class="btn btn-primary">추가</button>
          <button onclick="closeModal('addItemModal')" class="btn btn-outline">닫기</button>
        </div>
      </div>
    </div>
  </div>


  <!-- ✅ 공통 스크립트 -->
  <script>
    function openModal(id) {
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'flex';
    }

    function closeModal(id) {
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'none';
    }

    function openSpecModal(itemId, itemName) {
      const specList = document.getElementById("specList");
      specList.innerHTML = '';
      const variants = variantMap[String(itemId)] || [];

      const itemCard = document.querySelector(`.variant-card[data-item-id="${itemId}"]`);
      const itemDescription = itemCard?.dataset.description || "";

      variants.forEach(v => {
      const btn = document.createElement("button");
      // ★ 재고 표기 추가!
      btn.innerHTML = `${v.spec_label} <span style="color:#666;font-size:12px;">(${v.stock ?? 0}개)</span>`;
      btn.style.padding = '6px';
      btn.onclick = () => {
        selectVariant(v.id, `${itemName} - ${v.spec_label}`);
        closeSpecModal();
    };
      specList.appendChild(btn);
    });

      document.getElementById("specModalTitle").innerText = `${itemName} - 규격 선택`;
      document.getElementById("specDescription").innerText = itemDescription;
      document.getElementById("specModal").style.display = 'flex';
    }

    function confirmAction() {
      alert("처리되었습니다.");
      closeModal('exampleModal');
    }

    function submitNewItem() {
      const name = document.getElementById('newItemName').value;
      const specs = document.getElementById('newItemSpecs').value;
      const categoryId = document.getElementById('newItemCategory').value;

      fetch("{% url 'add_item_ajax' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
          name: name,
          specs: specs,
          category_id: categoryId
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert("✅ 품목이 추가되었습니다!");
            closeModal('addItemModal');
            location.reload();
          } else {
            alert("❌ 추가 실패: " + (data.message || '오류 발생'));
          }
        });
    }
    window.addEventListener('click', function (event) {
      const modal = document.getElementById('addItemModal');
      if (modal && event.target === modal) {
        modal.style.display = 'none';
      }
      const batchModal = document.getElementById('batchModal');
      if (batchModal && event.target === batchModal) {
        batchModal.style.display = 'none';
      }

      const confirmModal = document.getElementById('confirmModal');
      if (confirmModal && event.target === confirmModal) {
        confirmModal.style.display = 'none';
      }

      const specModal = document.getElementById('specModal');
      if (specModal && event.target === specModal) {
        specModal.style.display = 'none';
      }
    });

    function toggleFavorite(e, itemId) {
      e.stopPropagation(); // 모달 열기 방지
      let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");

      if (favorites.includes(itemId)) {
        favorites = favorites.filter(id => id !== itemId);
      } else {
        favorites.push(itemId);
      }

      localStorage.setItem("favorites", JSON.stringify(favorites));
      updateFavoriteIcons();  // 새로고침 없이 아이콘과 정렬 갱신
    }

    function updateFavoriteIcons() {
      const favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
      const grid = document.getElementById("item-grid");
      const cards = Array.from(grid.children);

      const favoriteCards = [];
      const otherCards = [];

      cards.forEach(card => {
        const itemId = card.getAttribute("data-item-id");
        const icon = card.querySelector(".favorite-icon");

        if (favorites.includes(itemId)) {
          icon.textContent = "★";
          icon.classList.add("favorited");
          favoriteCards.push(card);
        } else {
          icon.textContent = "☆";
          icon.classList.remove("favorited");
          otherCards.push(card);
        }
      });

      grid.innerHTML = "";
      [...favoriteCards, ...otherCards].forEach(card => grid.appendChild(card));
    }

    document.addEventListener("DOMContentLoaded", updateFavoriteIcons);
  </script>
</body>

</html>