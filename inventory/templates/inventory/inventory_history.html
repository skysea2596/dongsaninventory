{% extends 'inventory/base.html' %}

{% block title %}ì…ì¶œê³  ë‚´ì—­{% endblock %}

{% block content %}
<h2>ğŸ“Š ì…ì¶œê³  ë‚´ì—­</h2>

<!-- ğŸ” í•„í„° í¼ -->
<form method="get" class="filter-form">
  <label>êµ¬ë¶„:
    <select name="type">
      <option value="">ì „ì²´</option>
      <option value="IN" {% if filter_type == "IN" %}selected{% endif %}>ì…ê³ </option>
      <option value="OUT" {% if filter_type == "OUT" %}selected{% endif %}>ì†Œëª¨</option>
    </select>
  </label>

  <label>ì‚¬ìš©ì:
    <select name="user">
      <option value="">ì „ì²´</option>
      {% for user in users %}
      <option value="{{ user.id }}" {% if user.id|stringformat:"s" == selected_user %}selected{% endif %}>{{ user.name }}</option>
      {% endfor %}
    </select>
  </label>

  <label>í’ˆëª© + ê·œê²©:
    <select name="variant">
      <option value="">ì „ì²´</option>
      {% for variant in variants %}
      <option value="{{ variant.id }}" {% if variant.id|stringformat:"s" == selected_variant %}selected{% endif %}>
        {{ variant.item.name }} - {{ variant.spec.label }}
      </option>
      {% endfor %}
    </select>
  </label>

  <label>ì‹œì‘ì¼:
    <input type="date" name="start_date" value="{{ start_date }}">
  </label>

  <label>ì¢…ë£Œì¼:
    <input type="date" name="end_date" value="{{ end_date }}">
  </label>

  <button type="submit">ê²€ìƒ‰</button>
  <a href="{% url 'inventory_history' %}">ì´ˆê¸°í™”</a>
</form>

<!-- ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ -->
<div style="text-align: right; margin-bottom: 10px;">
  <form method="get" action="{% url 'export_inventory_log' %}">
    {% for key, value in request.GET.items %}
      <input type="hidden" name="{{ key }}" value="{{ value }}">
    {% endfor %}
    <button type="submit" class="btn btn-success">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
  </form>
</div>

<!-- ğŸ“‹ ì…ì¶œê³  í…Œì´ë¸” -->
<table class="styled-table">
  <thead>
    <tr>
      <th>ë‚ ì§œ</th>
      <th>ì‚¬ìš©ì</th>
      <th>í’ˆëª©</th>
      <th>ê·œê²©</th>
      <th>ìˆ˜ëŸ‰</th>
      <th>êµ¬ë¶„</th>
      <th>ì‘ì—…</th>
    </tr>
  </thead>
  <tbody>
    {% for log in logs %}
    <tr>
      <td>{{ log.timestamp|date:"Y-m-d H:i" }}</td>
      <td>{{ log.user.name }}</td>
      <td>{{ log.variant.item.name }}</td>
      <td>{{ log.variant.spec.label }}</td>
      <td>{{ log.quantity }}</td>
      <td>{{ log.get_type_display }}</td>
      <td>
        {% if log.type == 'OUT' %}
        <button type="button" class="btn btn-sm btn-warning" onclick="openCancelModal('{{ log.id }}')">ì·¨ì†Œ</button>
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="7">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- âŒ ì†Œëª¨ ì·¨ì†Œ ëª¨ë‹¬ -->
{% include 'inventory/includes/confirm_modal.html' with modal_id='cancelModal' message='ì •ë§ í•´ë‹¹ ì†Œëª¨ ê¸°ë¡ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' form_id='cancelForm' %}

<!-- â® í˜ì´ì§€ë„¤ì´ì…˜ -->
<div style="display: flex; justify-content: center; margin-top: 20px;">
  {% include 'inventory/includes/table_pagination.html' with page_obj=page_obj %}
</div>

<script>
  let currentCancelLogId = null;

  function openCancelModal(logId) {
    currentCancelLogId = logId;
    openConfirmModal("ì†Œëª¨ ê¸°ë¡ ì·¨ì†Œ", "ì •ë§ í•´ë‹¹ ì†Œëª¨ ê¸°ë¡ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", "submitCancelForm");
  }

  function submitCancelForm() {
    if (!currentCancelLogId) return;

    const form = document.createElement("form");
    form.method = "POST";
    form.action = `/history/cancel/${currentCancelLogId}/`;

    const csrfToken = '{{ csrf_token }}';
    const input = document.createElement("input");
    input.type = "hidden";
    input.name = "csrfmiddlewaretoken";
    input.value = csrfToken;

    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
  }
</script>
{% endblock %}
