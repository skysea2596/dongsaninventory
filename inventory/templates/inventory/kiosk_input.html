{% extends 'inventory/base.html' %}
{% load static %}
{% block title %}ì†Œëª¨ ì…ë ¥{% endblock %}

{% block content %}
<style>
  .page-container {
    display: flex;
    gap: 30px;
  }

  .main-content {
    flex: 1;
  }

  .sidebar-form {
    width: 300px;
    position: sticky;
    top: 80px;
    background: #f8f9fa;
    border-left: 1px solid #ccc;
    padding: 20px;
    height: fit-content;
    border-radius: 8px;
  }
</style>
<div class="page-container">
  <div class="main-content">
    <input type="text" id="item-search" placeholder="ğŸ” í’ˆëª© ê²€ìƒ‰" style="width: 100%; padding: 8px; margin-bottom: 10px;"
      onkeyup="filterItems()">

    <!-- ğŸ”¹ ì¹´í…Œê³ ë¦¬ í•„í„° -->
    {% include 'inventory/includes/category_filter.html' with categories=categories %}

    <!-- ğŸ”¹ í’ˆëª© ëª©ë¡ -->
    {% include 'inventory/includes/variant_grid.html' %}
  </div>

  <!-- ğŸ”¹ ìš°ì¸¡ ê³ ì •: ì„ íƒ í•­ëª© + ì†Œëª¨ í¼ -->
  <div class="sidebar-form">
    <h4 style="margin-top: 0;">ğŸ§º ì„ íƒí•œ í’ˆëª©</h4>
    <form id="kioskForm">
      {% csrf_token %}
      <label for="user">ì‚¬ìš©ì:</label>
      <select name="user" id="user" required style="width: 100%; margin-bottom: 10px;">
        <option value="">ì‚¬ìš©ì ì„ íƒ</option>
        {% for user in users %}
        <option value="{{ user.id }}">{{ user.name }}</option>
        {% endfor %}
      </select>

      <div id="selected-items" style="margin-top: 10px; display: flex; flex-direction: column; gap: 10px;"></div>

      <button type="button" onclick="openConfirmModal('ì†Œëª¨ í™•ì¸', 'ì •ë§ ì†Œëª¨ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'submitKioskForm')"
        class="btn btn-danger" style="margin-top: 20px; width: 100%;">ğŸ§¯ ì†Œëª¨ ì²˜ë¦¬</button>
    </form>
  </div>
</div>

<!-- ğŸ”¹ ê·œê²© ì„ íƒ ëª¨ë‹¬ -->
<div id="specModal"
  style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px 30px; border-radius:10px; width:400px; position:relative;">
    <button onclick="closeSpecModal()" style="position:absolute; top:10px; right:10px;">âœ–</button>
    <h3 id="specModalTitle">ê·œê²© ì„ íƒ</h3>
    <p id="specDescription" style="margin-top:8px; font-size:13px; color:#666; white-space:pre-wrap;"></p>
    <div id="specList" style="margin-top:15px; display:flex; flex-direction:column; gap:10px;"></div>
  </div>
</div>

{% include 'inventory/includes/confirm_modal.html' with modal_title='ì†Œëª¨ í™•ì¸' modal_message='ì •ë§ ì†Œëª¨ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' confirm_function='submitKioskForm' %}

<script>
  const selectedItems = {};
  const variantMap = JSON.parse('{{ variant_json|escapejs }}');

  function closeSpecModal() {
    document.getElementById("specModal").style.display = 'none';
  }

  function openSpecModal(itemId, itemName) {
    alert("openSpecModal í˜¸ì¶œë¨!");
    const specList = document.getElementById("specList");
    specList.innerHTML = '';
    const variants = variantMap[String(itemId)] || [];

    const itemCard = document.querySelector(`.variant-card[data-item-id="${itemId}"]`);
    const itemDescription = itemCard?.dataset.description || "ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.";
    console.log('itemId:', itemId, typeof itemId);
    console.log('variantMap:', variantMap);
    console.log('openSpecModal variants:', variants);
    variants.forEach(v => {
      console.log(`variant[${idx}]:`, v);
      const btn = document.createElement("button");
      btn.innerHTML = `${v.spec_label} ${variant.stock ?? 0}</span>`;
      btn.style.padding = '6px';
      btn.onclick = () => {
        selectVariant(v.id, `${itemName} - ${v.spec_label}`);
        closeSpecModal();
      };
      specList.appendChild(btn);
    });

    document.getElementById("specModalTitle").innerText = `${itemName} - ê·œê²© ì„ íƒ`;
    document.getElementById("specDescription").innerText = itemDescription;
    document.getElementById("specModal").style.display = 'flex';
  }

  

  function selectVariant(id, label) {
    if (selectedItems[id]) {
      const row = document.querySelector(`.variant-selected-row[data-id="${id}"]`);
      const qtyInput = row.querySelector('input[name="quantities"]');
      qtyInput.value = parseInt(qtyInput.value) + 1;
      return;
    }

    selectedItems[id] = true;
    const container = document.getElementById("selected-items");
    const row = document.createElement("div");
    row.className = "variant-selected-row";
    row.dataset.id = id;
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.gap = "10px";

    row.innerHTML = `
      <input type="hidden" name="variant_ids" value="${id}">
      <span style="flex: 1;">${label}</span>
      <input type="number" name="quantities" min="1" value="1" style="width: 60px;">
      <button type="button" onclick="removeVariant('${id}', this)" style="border: none; background: none; color: red; font-size: 18px;">&times;</button>
    `;

    container.appendChild(row);
  }

  function removeVariant(id, btn) {
    delete selectedItems[id];
    btn.closest('.variant-selected-row').remove();
  }

  function submitKioskForm() {
    const userId = document.getElementById("user").value;
    const selected = document.querySelectorAll(".variant-selected-row");
    const variantData = [];

    selected.forEach(row => {
      const id = row.dataset.id;
      const qty = row.querySelector('input[name="quantities"]').value;
      variantData.push({ id: id, qty: qty });
    });

    fetch("/kiosk_input_ajax/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        user: userId,
        variants: variantData
      })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          document.getElementById("selected-items").innerHTML = '';
        } else {
          alert(data.message);
        }
      })
      .catch(err => {
        alert("âŒ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
  }

  function filterItems() {
    const keyword = document.getElementById("item-search").value.toLowerCase();
    const cards = document.querySelectorAll(".variant-card");
    cards.forEach(card => {
      const name = card.dataset.name?.toLowerCase() || '';
      const desc = card.dataset.description?.toLowerCase() || '';
      const match = name.includes(keyword) || desc.includes(keyword);
      card.style.display = match ? "block" : "none";
    });
  }

  function filterByCategory(categoryId) {
    const cards = document.querySelectorAll(".variant-card");
    cards.forEach(card => {
      const itemCategory = card.getAttribute("data-category");
      if (categoryId === 'all' || itemCategory === categoryId) {
        card.style.display = 'block';
      } else {
        card.style.display = 'none';
      }
    });
  }
</script>
{% endblock %}