{% extends 'inventory/base.html' %}
{% block title %}ì…ê³  ëŒ€ê¸°{% endblock %}

{% block content %}
<div class="header-bar">
  <h2>ğŸ•’ ì…ê³  ëŒ€ê¸° ëª©ë¡</h2>
  <a href="{% url 'paste_table_upload' %}" class="btn-register">ì…ê³ ëŒ€ê¸° ë“±ë¡</a>
</div>

<table class="styled-table">
  <thead>
    <tr>
      <th>ë‚ ì§œ</th>
      <th>ê±°ë˜ì²˜</th>
      <th>ìƒíƒœ</th>
      <th>ì‘ì—…</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th colspan="4" class="section-header">â³ ëŒ€ê¸° ì¤‘</th>
    </tr>
    {% for batch in pending_batches %}
    <tr>
      <td>{{ batch.formatted_date }}</td>
      <td>{{ batch.supplier }}</td>
      <td>ëŒ€ê¸°ì¤‘</td>
      <td><button type="button" onclick="showBatchModal('{{ batch.id }}', true)" class="btn btn-sm">ë³´ê¸°</button></td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="4">ëŒ€ê¸° ì¤‘ ì…ê³ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</td>
    </tr>
    {% endfor %}

    <tr>
      <th colspan="4" class="section-header">âœ… ì™„ë£Œëœ ì…ê³ </th>
    </tr>
    {% for batch in done_batches %}
    <tr>
      <td>{{ batch.formatted_date }}</td>
      <td>{{ batch.supplier }}</td>
      <td>ì™„ë£Œ</td>
      <td><button type="button" onclick="showBatchModal('{{ batch.id }}', false)" class="btn btn-sm">ë³´ê¸°</button></td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="4">ì™„ë£Œëœ ì…ê³ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- âœ… ì…ê³  ëŒ€ê¸° ìƒì„¸ ëª¨ë¸ -->
{% include 'inventory/includes/batch_modal.html' %}

<script>
  let currentBatchId = null;
  let currentIsPending = false;
  let currentPendingItems = [];

  function showBatchModal(batchId, isPending) {
    currentBatchId = parseInt(batchId);
    currentIsPending = isPending;

    fetch(`/pending_stock/${batchId}/items/`)
      .then(res => res.json())
      .then(data => {
        // messageê°€ ì—†ëŠ” ê²½ìš° ë°©ì–´ì²˜ë¦¬
        if (!data.message || !Array.isArray(data.message.items)) {
          alert("API ì‘ë‹µì— items ë°°ì—´ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        document.getElementById("batchModalTitle").innerText = `ğŸ“œ ${data.message.supplier} ì…ê³  í•­ëª©`;
        const list = document.getElementById("batchItemList");
        list.innerHTML = '';
        currentPendingItems = data.message.items;

        data.message.items.forEach(item => {
          const li = document.createElement("li");
          li.dataset.itemId = item.id;
          li.innerHTML = `
            <span>${item.item}</span> -
            ${currentIsPending ? `<input type="number" value="${item.quantity}" min="1" style="width:60px;"> ê°œ` : `${item.quantity}ê°œ`}
          `;
          list.appendChild(li);
        });

        document.getElementById("processButton").style.display = currentIsPending ? 'inline-block' : 'none';
        document.getElementById("cancelButton").style.display = currentIsPending ? 'inline-block' : 'none';

        document.getElementById("batchModal").style.display = 'flex';
      })
  }

  function closeBatchModal() {
    document.getElementById("batchModal").style.display = 'none';
    currentBatchId = null;
    currentPendingItems = [];
  }

  function cancelBatch() {
    if (!currentBatchId) return;
    if (!confirm("ì •ë§ ì´ ì…ê³  ëŒ€ê¸° ê±´ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    fetch(`/pending_stock/${currentBatchId}/cancel/`, {
      method: "POST",
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if (data.success) location.reload();
      });
  }

  function processBatch() {
    if (!currentBatchId) return;
    if (!confirm("ì…ê³  ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const updates = [];
    document.querySelectorAll("#batchItemList li").forEach(li => {
      const id = parseInt(li.dataset.itemId);
      const input = li.querySelector('input[type="number"]');
      if (input) {
        const qty = parseInt(input.value);
        if (qty > 0) updates.push({ id: id, qty: qty });
      }
    });

    fetch(`/pending_stock/${currentBatchId}/process/`, {
      method: "POST",
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ quantities: updates })
    })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if (data.success) location.reload();
      });
  }
</script>
{% endblock %}