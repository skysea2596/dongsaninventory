{% extends 'inventory/base.html' %}
{% block title %}입고 대기{% endblock %}

{% block content %}
<div class="header-bar">
  <h2>🕒 입고 대기 목록</h2>
  <a href="{% url 'paste_table_upload' %}" class="btn-register">입고대기 등록</a>
</div>

<table class="styled-table">
  <thead>
    <tr>
      <th>날짜</th>
      <th>거래처</th>
      <th>상태</th>
      <th>작업</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th colspan="4" class="section-header">⏳ 대기 중</th>
    </tr>
    {% for batch in pending_batches %}
    <tr>
      <td>{{ batch.formatted_date }}</td>
      <td>{{ batch.supplier }}</td>
      <td>대기중</td>
      <td><button type="button" onclick="showBatchModal('{{ batch.id }}', true)" class="btn btn-sm">보기</button></td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="4">대기 중 입고건이 없습니다.</td>
    </tr>
    {% endfor %}

    <tr>
      <th colspan="4" class="section-header">✅ 완료된 입고</th>
    </tr>
    {% for batch in done_batches %}
    <tr>
      <td>{{ batch.formatted_date }}</td>
      <td>{{ batch.supplier }}</td>
      <td>완료</td>
      <td><button type="button" onclick="showBatchModal('{{ batch.id }}', false)" class="btn btn-sm">보기</button></td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="4">완료된 입고건이 없습니다.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- ✅ 입고 대기 상세 모델 -->
{% include 'inventory/includes/batch_modal.html' %}

<script>
  let currentBatchId = null;
  let currentIsPending = false;
  let currentPendingItems = [];

  function showBatchModal(batchId, isPending) {
    currentBatchId = parseInt(batchId);
    currentIsPending = isPending;

    fetch(`/pending_stock/${batchId}/items/`)
      .then(res => res.json())
      .then(data => {
        // message가 없는 경우 방어처리
        if (!data.message || !Array.isArray(data.message.items)) {
          alert("API 응답에 items 배열이 없습니다.");
          return;
        }

        document.getElementById("batchModalTitle").innerText = `📜 ${data.message.supplier} 입고 항목`;
        const list = document.getElementById("batchItemList");
        list.innerHTML = '';
        currentPendingItems = data.message.items;

        data.message.items.forEach(item => {
          const li = document.createElement("li");
          li.dataset.itemId = item.id;
          li.innerHTML = `
            <span>${item.item}</span> -
            ${currentIsPending ? `<input type="number" value="${item.quantity}" min="1" style="width:60px;"> 개` : `${item.quantity}개`}
          `;
          list.appendChild(li);
        });

        document.getElementById("processButton").style.display = currentIsPending ? 'inline-block' : 'none';
        document.getElementById("cancelButton").style.display = currentIsPending ? 'inline-block' : 'none';

        document.getElementById("batchModal").style.display = 'flex';
      })
  }

  function closeBatchModal() {
    document.getElementById("batchModal").style.display = 'none';
    currentBatchId = null;
    currentPendingItems = [];
  }

  function cancelBatch() {
    if (!currentBatchId) return;
    if (!confirm("정말 이 입고 대기 건을 취소하시겠습니까?")) return;

    fetch(`/pending_stock/${currentBatchId}/cancel/`, {
      method: "POST",
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if (data.success) location.reload();
      });
  }

  function processBatch() {
    if (!currentBatchId) return;
    if (!confirm("입고 처리하시겠습니까?")) return;

    const updates = [];
    document.querySelectorAll("#batchItemList li").forEach(li => {
      const id = parseInt(li.dataset.itemId);
      const input = li.querySelector('input[type="number"]');
      if (input) {
        const qty = parseInt(input.value);
        if (qty > 0) updates.push({ id: id, qty: qty });
      }
    });

    fetch(`/pending_stock/${currentBatchId}/process/`, {
      method: "POST",
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ quantities: updates })
    })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if (data.success) location.reload();
      });
  }
</script>
{% endblock %}